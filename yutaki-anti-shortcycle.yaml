blueprint:
  name: Gestion PAC Yutaki (anti-cycles courts par temporisation)
  description: >
    Automatise le pilotage d'une pompe Ã  chaleur Hitachi Yutaki via un relais (bornes 13/14),
    afin d'Ã©viter les cycles courts. Lorsque la PAC est arrÃªtÃ©e, elle ne peut redÃ©marrer qu'aprÃ¨s
    une temporisation paramÃ©trable.
  domain: automation
  input:
    pac_switch:
      name: Interrupteur PAC
      description: Relais connectÃ© aux bornes 13/14 (contact sec)
      selector:
        entity:
          domain: switch
    start_trigger:
      name: DÃ©clencheur de mise en marche
      description: EntitÃ© qui dÃ©clenche la demande de marche (ex: tempÃ©rature ou boolÃ©en)
      selector:
        entity: {}
    min_off_duration:
      name: DurÃ©e minimale d'arrÃªt
      description: DurÃ©e pendant laquelle la PAC doit rester Ã©teinte avant de pouvoir redÃ©marrer
      default: 00:20:00
      selector:
        duration:
          min: 00:01:00
          max: 01:00:00

mode: restart

variables:
  last_off: >
    {% set history = state_attr(input.pac_switch, 'last_changed') %}
    {% if is_state(input.pac_switch, 'off') %}
      {{ now() }}
    {% else %}
      {{ state_attr(input.pac_switch, 'last_changed') }}
    {% endif %}

trigger:
  - platform: state
    entity_id: !input start_trigger
    to: 'on'
    id: demande_marche

  - platform: state
    entity_id: !input start_trigger
    to: 'off'
    id: demande_arret

condition: []

action:
  - choose:

      # â›” DEMANDE DE MARCHE mais trop tÃ´t : on ignore
      - conditions:
          - condition: trigger
            id: demande_marche
          - condition: template
            value_template: >
              {% set delta = (now() - state_attr(input.pac_switch, 'last_changed')).total_seconds() %}
              {{ is_state(input.pac_switch, 'off') and delta < (input.min_off_duration.total_seconds()) }}
        sequence:
          - service: logbook.log
            data:
              name: PAC Yutaki
              message: Marche ignorÃ©e : dÃ©lai minimal non Ã©coulÃ©.
              entity_id: !input pac_switch

      # âœ… DEMANDE DE MARCHE autorisÃ©e
      - conditions:
          - condition: trigger
            id: demande_marche
          - condition: template
            value_template: >
              {% set delta = (now() - state_attr(input.pac_switch, 'last_changed')).total_seconds() %}
              {{ is_state(input.pac_switch, 'off') and delta >= (input.min_off_duration.total_seconds()) }}
        sequence:
          - service: switch.turn_on
            target:
              entity_id: !input pac_switch

      # ðŸ›‘ DEMANDE D'ARRÃŠT
      - conditions:
          - condition: trigger
            id: demande_arret
        sequence:
          - service: switch.turn_off
            target:
              entity_id: !input pac_switch
